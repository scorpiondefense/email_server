# Email Server Docker Compose Configuration
# ==========================================
#
# Usage:
#   1. Copy .env.example to .env and configure your settings
#   2. Run: docker-compose up -d
#   3. Create users: docker-compose exec email create-user add user@yourdomain.com
#
# For production deployment on a VPS:
#   - Update SERVER_IP in .env to your VPS public IP
#   - Update MAIL_DOMAIN to your domain
#   - Configure DNS records (MX, A, PTR, SPF)
#   - Consider using Let's Encrypt certificates
#

version: '3.8'

services:
  email:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: email-server
    hostname: ${MAIL_HOSTNAME:-mail.example.com}
    restart: unless-stopped

    # Environment configuration
    environment:
      # Domain settings
      - MAIL_DOMAIN=${MAIL_DOMAIN:-example.com}
      - MAIL_HOSTNAME=${MAIL_HOSTNAME:-mail.example.com}
      - SERVER_IP=${SERVER_IP:-0.0.0.0}

      # Initial admin user (created on first run)
      - ADMIN_EMAIL=${ADMIN_EMAIL:-}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-}

      # Server limits
      - MAX_CONNECTIONS=${MAX_CONNECTIONS:-1000}
      - MAX_MESSAGE_SIZE=${MAX_MESSAGE_SIZE:-26214400}
      - MAX_RECIPIENTS=${MAX_RECIPIENTS:-100}
      - DEFAULT_QUOTA=${DEFAULT_QUOTA:-104857600}

      # SMTP settings
      - SMTP_REQUIRE_AUTH=${SMTP_REQUIRE_AUTH:-true}
      - SMTP_ALLOW_RELAY=${SMTP_ALLOW_RELAY:-false}

      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-info}

    # Port mappings
    ports:
      # SMTP
      - "${SERVER_IP:-0.0.0.0}:25:25"      # SMTP (MTA)
      - "${SERVER_IP:-0.0.0.0}:465:465"    # SMTPS (implicit TLS)
      - "${SERVER_IP:-0.0.0.0}:587:587"    # Submission (STARTTLS)
      # POP3
      - "${SERVER_IP:-0.0.0.0}:110:110"    # POP3
      - "${SERVER_IP:-0.0.0.0}:995:995"    # POP3S (implicit TLS)
      # IMAP
      - "${SERVER_IP:-0.0.0.0}:143:143"    # IMAP
      - "${SERVER_IP:-0.0.0.0}:993:993"    # IMAPS (implicit TLS)

    # Persistent volumes
    volumes:
      # Mail storage
      - mail_data:/var/mail
      # User database
      - db_data:/var/lib/email_server
      # SSL certificates (mount your own or let container generate self-signed)
      - certs:/etc/ssl/email_server
      # Configuration (optional - uncomment to use custom config file)
      # - ./config/server.conf:/etc/email_server/server.conf:ro
      # Logs
      - logs:/var/log/email_server

    # Health check
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "25"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # Resource limits (adjust based on your VPS)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M

    # Security options
    security_opt:
      - no-new-privileges:true

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# Named volumes for persistence
volumes:
  mail_data:
    driver: local
  db_data:
    driver: local
  certs:
    driver: local
  logs:
    driver: local

  # Webmail client
  webmail:
    build:
      context: ./webmail
      dockerfile: Dockerfile
    container_name: webmail
    restart: unless-stopped

    environment:
      - NODE_ENV=production
      - JWT_SECRET=${JWT_SECRET:-change-this-in-production-to-a-random-string}
      - SESSION_EXPIRY=${SESSION_EXPIRY:-86400}
      # IMAP settings
      - IMAP_HOST=${IMAP_HOST:-email}
      - IMAP_PORT=${IMAP_PORT:-993}
      - IMAP_SECURE=${IMAP_SECURE:-true}
      # SMTP settings
      - SMTP_HOST=${SMTP_HOST:-email}
      - SMTP_PORT=${SMTP_PORT:-465}
      - SMTP_SECURE=${SMTP_SECURE:-true}

    ports:
      - "${SERVER_IP:-0.0.0.0}:3000:3000"

    depends_on:
      - email

    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# Named volumes for persistence
volumes:
  mail_data:
    driver: local
  db_data:
    driver: local
  certs:
    driver: local
  logs:
    driver: local

# Network configuration
networks:
  default:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
